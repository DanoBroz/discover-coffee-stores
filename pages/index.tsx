import Head from "next/head";
import styles from "../styles/Home.module.css";
import Banner from "../components/Banner";
import { MouseEvent, useContext, useEffect } from "react";
import Image from "next/image";
import Card from "../components/Card";
import coffeeStoresDummy from "../data/coffee-stores.json";
import { GetStaticProps } from "next";
import { fetchCoffeeStores } from "../lib/coffee-stores";
import { useTrackLocation } from "../hooks/useTrackLocation";
import { StoreContext } from "../store/store-context";

export interface CoffeeStore {
    id: string;
    name: string;
    imgUrl: string;
    websiteUrl: string;
    location: {
        address: string;
        neighborhood: string[];
    };
}

interface HomeProps {
    coffeeStores: CoffeeStore[];
}

export const getStaticProps: GetStaticProps = async (context) => {
    const coffeeStoresData = await fetchCoffeeStores();

    return {
        props: {
            coffeeStores: coffeeStoresData,
        },
    };
};

export default function Home(props: HomeProps) {
    const { handleTrackLocation, locationErrorMsg, isFindingLocation } =
        useTrackLocation();

    const { dispatch, state } = useContext(StoreContext);

    const handleClick = (e: MouseEvent) => {
        e.preventDefault();
        handleTrackLocation();
    };

    useEffect(() => {
        async function setCoffeeStoresByLocation() {
            if (state.latLong) {
                try {
                    const fetchedCoffeeStores = await fetch(
                        `/api/getCoffeeStoresByLocation?latLong=${state.latLong}&limit=30`
                    );
                    const coffeeStores = await fetchedCoffeeStores.json();
                    dispatch({
                        type: "SET_COFFEE_STORES",
                        payload: {
                            ...state,
                            coffeeStores,
                        },
                    });
                } catch (error) {
                    console.log(error);
                }
            }
        }
        setCoffeeStoresByLocation();
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [state.latLong]);

    return (
        <>
            <Head>
                <title>Coffee Connoisseur</title>
                <meta
                    name="description"
                    content="Generated by create next app"
                />
                <meta
                    name="viewport"
                    content="width=device-width, initial-scale=1"
                />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <main className={styles.main}>
                <Banner
                    buttonText={
                        isFindingLocation ? "Locating..." : "View stores nearby"
                    }
                    buttonFunction={handleClick}
                />
                {locationErrorMsg && (
                    <p>Something went wrong: {locationErrorMsg}</p>
                )}
                <div className={styles.heroImage}>
                    <Image
                        src="/static/hero-image.png"
                        width={700}
                        height={400}
                        alt="hero - girl with coffee sitting on clouds"
                    />
                </div>
                {state.coffeeStores.length > 0 && (
                    <>
                        <h2 className={styles.heading2}>stores near me</h2>
                        <div className={styles.cardLayout}>
                            {state.coffeeStores.map((store) => (
                                <Card
                                    key={store.id}
                                    name={store.name}
                                    imageUrl={
                                        store.imgUrl ||
                                        coffeeStoresDummy[0].imgUrl
                                    }
                                    href={`/coffee-store/${store.id}`}
                                />
                            ))}
                        </div>
                    </>
                )}

                {props.coffeeStores.length > 0 && (
                    <>
                        <h2 className={styles.heading2}>
                            Ostrava-poruba stores
                        </h2>
                        <div className={styles.cardLayout}>
                            {props.coffeeStores.map((store) => (
                                <Card
                                    key={store.id}
                                    name={store.name}
                                    imageUrl={
                                        store.imgUrl ||
                                        coffeeStoresDummy[0].imgUrl
                                    }
                                    href={`/coffee-store/${store.id}`}
                                />
                            ))}
                        </div>
                    </>
                )}
            </main>
        </>
    );
}
